<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Singapore PSI Table (D3.js)</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 40px;
  }
  table {
    border-collapse: collapse;
    margin: 0 auto;
    font-size: 14px;
  }
  th, td {
    border: 1px solid #999;
    padding: 8px 12px;
    text-align: center;
  }
  th {
    background-color: #f0f0f0;
  }
  caption {
    caption-side: top;
    font-size: 1.3em;
    font-weight: bold;
    margin-bottom: 10px;
  }
  #loading {
    font-size: 1.1em;
    color: #555;
  }
</style>
</head>
<body>
  <div id="loading">Fetching real-time PSI data...</div>
  <div id="table-container"></div>

  <script>
    // === 主流程：从 Data.gov.sg 获取空气质量数据 ===
    fetch('https://api.data.gov.sg/v1/environment/psi')
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        document.getElementById('loading').textContent = ''; // 清除加载提示
        renderPSITable(data);
      })
      .catch(error => {
        document.getElementById('loading').textContent = 'Error fetching data.';
        console.error('Fetch error:', error);
      });

    // === 解析 PSI 数据并生成表格 ===
    function renderPSITable(data) {
      const readings = data.items[0].readings;
      const updateTimeRaw = data.items[0].update_timestamp; // 原始时间戳
      const updateTime = formatTimestamp(updateTimeRaw);    // 格式化时间

      // 提取区域名（west, east, central, south, north）
      const regions = Object.keys(readings["psi_twenty_four_hourly"]);

      // 提取所有污染指标名
      const metrics = Object.keys(readings);

      // 构建表格数据：每个区域是一行
      const tableData = regions.map(region => {
        const entry = { region };
        metrics.forEach(metric => {
          entry[metric] = readings[metric][region];
        });
        return entry;
      });

      // 渲染表格
      createTable(tableData, updateTime);
    }

    // === 使用 D3.js 创建表格 ===
    function createTable(data, updateTime) {
      const container = d3.select("#table-container");
      container.selectAll("*").remove(); // 清空旧表格

      const table = container.append("table");

      // === 添加标题和更新时间 ===
      table.append("caption")
        .text(`Singapore PSI Air Quality Data — Updated at: ${updateTime}`);

      // === 表头 ===
      const headers = Object.keys(data[0]);
      const thead = table.append("thead");
      thead.append("tr")
        .selectAll("th")
        .data(headers)
        .enter()
        .append("th")
        .text(d => d);

      // === 表体 ===
      const tbody = table.append("tbody");
      const rows = tbody.selectAll("tr")
        .data(data)
        .enter()
        .append("tr");

      rows.selectAll("td")
        .data(d => Object.values(d))
        .enter()
        .append("td")
        .text(d => d);
    }

    // === 格式化时间戳函数 ===
    function formatTimestamp(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleString("en-SG", {
        year: "numeric",
        month: "short",
        day: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        timeZoneName: "short"
      });
    }
  </script>
</body>
</html>
